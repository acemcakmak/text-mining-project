charlie is heartbroken when his girlfriend of three years , mallory , breaks up with him .